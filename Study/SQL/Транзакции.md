## Транзакции

Транзакция - серия из одной или несколько операций, которые должны   выполниться полностью, либо не выполниться вообще.

### ACID

Транзакции имеют определенные свойства: **ACID**

- Атомарность (Atomicity): все изменения данных выполняются так, если бы они были одной операцией. Т.е. выполняются все изменения или ни одно из них.
- Согласованность (Consistency): гарантирует, что по мере выполнения транзакций данные переходят из одного состояния в другое
- Изолированность (Isolation): все транзакции работают независимо друг от друга и прозрачно.
- Долговечность (Durability): гарантирует, что результат совершенной транзакции сохранится в случае сбоя системы.

### Проблемы параллельной работы двух или более изолированных транзакций

Выделяют следующие проблемы параллельной работы двух или более изолированных транзакций:

#### Грязное чтение

Если транзакция находится в процессе обновления некоторых данных и еще не зафиксирована, а другой транзакции разрешено читать эти не зафиксированные данные, это может привести к тому, что приложение покажет неверные данные, которые были отброшены.

Вот как может выглядеть **грязное чтение** в `SQL`:

```sql
### Transaction 1 ###

SELECT user_login_token_id
FROM tokens

UPDATE tokens
SET token_status = "invalid"
WHERE token_id = user_login_token_id

### Transaction 2 ###

SELECT user_login_token_id
FROM tokens
```

#### Неповторяющиеся чтения

Ситуация, когда при повторном чтение в рамках одной транзакции ранее прочитанные данные оказываются изменёнными.

Вот как может выглядеть **неповторяющиеся чтения** в `SQL`:

```sql
### Transaction 1 ###

SELECT post_title
FROM posts

SELECT
	post_title,
	post_content
FROM posts

### Transaction 2 ###

UPDATE posts
SET post_title = "something_new"
WHERE post_title = post_title
```

#### Чтение "Фантомов"

Ситуация, когда при повторном чтение в рамках одной транзакции одна и та же выборка дает разное кол-во данных.

Вот как может выглядеть **чтение "фантомов"** в `SQL`:

```sql
### Transaction 1 ###

SELECT post_title
FROM posts

SELECT
	post_title,
	post_content
FROM posts

### Transaction 2 ###

INSERT INTO posts
VALUES "something_new", ...
```

## Уровни изоляции

Уровень изоляции транзакции - свойство систем баз данных, которое контролирует взаимодействие транзакций друг с другом.

Выделяют 4 стандартных уровня изоляции, которые может поддерживать система БД:

- `Read uncommitted`: это самый низкий уровень изоляции, который имеет самую плохую согласованность данных, но самую высокую скорость выполнения транзакций. Каждая транзакция видит незафиксированные изменения другой транзакции (феномен **грязного чтения**).
- `Read committed`: этот уровень гарантирует, что транзакция может считывать только те данные, которые были зафиксированы другими транзакциями. Таким образом, данный уровень обеспечивает защиту от **грязного чтения**.
- `Repeatable read`: этот уровень гарантирует, что транзакция может считывать одни и те же данные несколько раз, и гарантирует, что любые изменения, сделанные другими транзакциями, не будут видны для транзакции, пока она не будет зафиксирована. Однако фантомные чтения все еще могут происходить, то есть транзакция может видеть новые строки, которые были вставлены другими транзакциями между чтениями.
- `Serializable`: это самый высокий уровень изоляции, который обеспечивает последовательное выполнение транзакций, даже если они могут выполняться одновременно. Это гарантирует, что все транзакции будут видеть одни и те же данные, и что не будет фантомных или грязных чтений. Однако этот уровень может привести к снижению параллелизма и производительности из-за увеличения количества блокировок.