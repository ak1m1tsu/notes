HTTP cookie - небольшой фрагмент данных, который сервер отправляет браузеру пользователя. Браузер может сохранить этот фрагмент у себя и отправлять на сервер с каждым последующим запросом. Это позволяет узнать, с одно ли браузера пришли несколько запросов (например, для аутентификации пользователя).

Куки часто используются для:

- Управления сеансом (логины, корзины дли виртуальных покупок)
- Персонализации (пользовательские предпочтения)
- Трекинга (отслеживания поведения пользователей)

## Создание

Получив HTTP-запрос, вместе с ответом сервер может отправить заголовок [Set-Cookie](https://developer.mozilla.org/ru/docs/Web/HTTP/Headers/Set-Cookie). Куки обычно запоминаются браузером и посылаются в HTTP-заголовке [Cookie](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Cookie) с каждым новым запросом к одному и тому же серверу. Для куки можно задать срок их жизни, срок их свежести, указать ограничения на путь и домен.

### Заголовки Set-Cookie и Cookie

Заголовок **Set-Cookie** HTTP-ответа используется для отправки куки с сервера в клиентское приложение. Простой куки может задаваться так:

```
Set-Cookie: <cookie-name>=<cookie-header>
```

Этот заголовок с сервера дает клиенту указание сохранить куки. Ответ, отправляемый браузеру, содержит заголовок **Set-Cookie**, и куки запоминается браузером.

```
HTTP/1.0 200 OK
Content-type: text/html
Set-Cookie: yummy_cookie=choco
Set-Cookie: tasty_cookie=strawberry

[page content]
```

С каждым новым запросом к серверу при помощи заголовка [Cookie](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Cookie) браузер будет возвращать серверу все сохраненные ранее куки.

```
GET /sample_page.html HTTP/1.1
Host: www.example.org
Cookie: yummy_cookie=choco; tasty_cookie=strawberry
```

### Сессионные cookie

Сессионные cookie - cookie, которые удаляются при закрытии клиента, то есть существуют только на протяжении текущего сеанса, поскольку атрибуты *Expires* или *Max-Age* для него не задаются.

### Постоянные cookies

Постоянные cookie удаляются не с закрытием клиента, а при наступлении определенной даты или после определенного интервала времени.

```
Set-Cookie: id=a3fWa; Expires=Wed, 21 Oct 2015 07:28:00 GMT;
```

### Secure и HttpOnly куки

*Безопасные* куки отсылаются на сервер только тогда, когда запрос отправляется по протоколу SSL и HTTPS. Однако важные данные никогда не следует передавать или хранить в куках, поскольку сам их механизм весьма уязвим в отношении безопасности, а флаг *secure* никакого дополнительного шифрования или средств защиты не обеспечивает.

Куки HTTPonly не доступны из JavaScript через свойства [Document.cookie](https://developer.mozilla.org/ru/docs/Web/API/Document/cookie) API, что помогает избежать межсайтового скриптинга. Этот флаг устанавливается для тех кук, к которым не требуеся обращаться через JavaScript. В частности, если куки используются только для поддержки сеаеса.

```
Set-Cookie: id=a3fWa; Expires=Wd, 21 Oct 2015 07:28:00 GMT; Secure; HttpOnly
```

### Область видимости куки

Директивы **Domain** и **Path** определяют область видимости куки, то есть те URL-адреса, к которым куки будут отсылаться.

### Атрибут Domain

Атрибут *Domain* указывает хосты, на которые отсылаются куки. Если он не задан, то по умолчанию берется доменная часть адреса документа. Если домен указан явно, то поддомены всегда включены.

Например, если задано `Domain=mozilla.org`, то куки включены и в поддоменнах, например, в `developer.mozilla.org`

### Атрибут Path

Атрибут *Path* указывает URL,который должен быть в запрашиваемом ресурсе на момент отправки заголовка *Cookie*. Символ %x2F ("/") интерпретируется как разделитель в URL-пути, подпути также будут учитываться

Если задан `Path=/docs`, то совпадать будут следующие пути:

- /docs
- /docs/
- /docs/Web/
- /docs/Web/HTTP

А эти не будут:

- /
- /docsets
- /fr/docs

### Куки SameSite

С помощью атрибута *SameSite* можно указать, когда и как отправлять куки с межсайтовыми запросами. В некоторой степени этот атрибут защищает от межсайтовой подделки запроса. *SameSIte* может принимать три возможных значения: `Strict`, `Lax` и `None`.

С атрибутом *Strict* куки будут отправляться только тому сайту, которому эти куки принадлежат. Атрибут *Lax* работает похоже, но куки будут отправляться также при навигации на тот сайт, которому принадлежат куки. Например, при переходе по ссылке с внешнего сайта. Атрибут *None* отключает ограничение на отправку кук для мейжайтовых запросов, но только в безопасном контексте (т.е. если установлен `SameSite=None`, тогда также должен быть установлен атрибут *Secure*). Если атрибут *SameSite* не установлен, куки будут восприниматься как *Lax*.

### Куки с префиксами

Куки с префиксами используются для гарантии специфических фактах о них. Всего доступно два перфикса:

`__Host-`
Если в куке содержится этот префикса, она будет установлена заголовком *Set-Cookie* только в том случае, если кука будетсодержать атрибут *Secure* и если запрос будет отправляться из защищенного источника. Также кука не должна включать атрибут *Domain* и должна содержать атрибут *Path* со значением `/`.

`__Secure-`
Если в куке содержится этот префикс, он будет установлена заголовком *Set-Cookie* только в том случае, если кука будет содержать атрибут *Secure* и если запрос будет отправляться из защищенного источника.

Браузеры будут отклонять установку этих кук, если они не будут удовлетворять все ограничениям. Куки с префиксами, созданные в рамках поддомена, будут ограничиваться только им или будут полностью игнорироваться.

## Безопасность

Способы предотвращения атак, использующих куки:

- Использовать атрибут *HttpOnly* для предотвращения доступа к кукам из **JavaScript**
- Куки, которые используются для хранения чувствительной информации, такой как аутентификационный токен, должны иметь короткое время жизни и атрибут *SameSite*, установленный в *Strict* или *Lax*.